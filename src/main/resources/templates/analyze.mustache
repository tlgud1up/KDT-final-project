<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/analyze.css">
</head>


<body class="analyze">
<input type="hidden" name="_csrf" value="{{_csrf.token}}">
{{>layout/header}}
<div class="container">
    <div class="title-container">
        <p class="title">ìˆœí™˜ ê³¨ì¬ í’ˆì§ˆ ë¶„ì„</p>
        <p class="notice">R-CNN,PCA,OpenCVë¥¼ í™œìš©í•˜ì—¬ ìˆœí™˜ê³¨ì¬ ë‚´ ë¶ˆìˆœë¬¼ì„ ê²€ì¶œí•˜ê³ ,
            í’ˆì§ˆ ê¸°ì¤€ì— ì í•©í•œì§€ ì—¬ë¶€ë¥¼ íŒì •í•©ë‹ˆë‹¤ <img src="/images/notice_icon.png" alt="ì•Œë¦¼" id="notice_icon" style="cursor:pointer;"></p>


        <div id="popup" class="popup">
            <div class="popup-content">
                <span id="close">&times;</span>
                <p>í’ˆì§ˆ ê¸°ì¤€ ë° ê·œì •</p>
                <p class="popup-explain">ìˆœí™˜ ê³¨ì¬ì˜ ìœ ê¸° ì´ë¬¼ì§ˆ í•¨ìœ ëŸ‰ì€ ê³¨ì¬ì†ì— í¬í•¨ëœ ë¹„ë‹,í”Œë¼ìŠ¤í‹±,ëª©ì¬ ë“±ì˜ í•¨ìœ ëŸ‰ì´
                    ì´ ê³¨ì¬ ìš©ì ì˜ 1.0% ì´í•˜ì´ì–´ì•¼ í•œë‹¤.<br>ê¸°ì¤€:KS F 2576(ìˆœí™˜ ê³¨ì¬ì˜ ì´ë¬¼ì§ˆ í•¨ìœ ëŸ‰ ì‹œí—˜ë°©ë²•)</p>
            </div>
        </div>
    </div>
    <div class="sample-container">
        <p class="sample-container-title">ìƒ˜í”Œ ì´ë¯¸ì§€ ì˜ˆì‹œ</p>
        <div class="sample-img-container">
            <div class="sample-img-box">
                <img class="sample-img" src="/images/good_sample.png" alt="ì¢‹ì€ ì˜ˆì‹œ1">
                <div class="sample-label good">ì¢‹ì€ ì˜ˆì‹œ</div>
            </div>
            <div class="sample-img-box">
                <img class="sample-img" src="/images/good_sample2.png" alt="ì¢‹ì€ ì˜ˆì‹œ2">
                <div class="sample-label good">ì¢‹ì€ ì˜ˆì‹œ</div>
            </div>
            <div class="sample-img-box">
                <img class="sample-img" src="/images/bad_sample.png" alt="ë‚˜ìœ ì˜ˆì‹œ">
                <div class="sample-label bad">ë‚˜ìœ ì˜ˆì‹œ</div>
            </div>
        </div>
    </div>
    <div class="upload-container">
        <div class="before-upload-container" id="before-upload-container">
            <h2>ì´ë¯¸ì§€ë¥¼ ì°¾ì•„ì„œ ì—…ë¡œë“œ í•˜ì„¸ìš”</h2>
            <p>íŒŒì¼ì€ JPEG, JPG, PNG ë˜ëŠ” WebP í˜•ì‹ì´ì–´ì•¼ í•˜ë©° ìµœëŒ€ ìš©ëŸ‰ì€ 10MBì…ë‹ˆë‹¤</p>
            <input type="file" id="file-input" accept="image/jpeg,image/jpg,image/png,image/webp" style="display:none">
            <button class="analyze-btn" id="select-file-btn">íŒŒì¼ ì„ íƒ</button>
        </div>
        <div class="preview-container" id="preview-container" style="display: none;">
            <img id="preview-img" src="" alt="ë¯¸ë¦¬ë³´ê¸°">
            <button class="analyze-btn" id="reselect-file-btn">ë‹¤ì‹œ ì„ íƒ</button>
        </div>
        <div class="analyze-container" style="display: none;">
            <div class="analyze-process">
                <div class="analyze-info">
                    <h2>ì´ë¯¸ì§€ ì „ì²˜ë¦¬</h2>
                    <p>ì´ë¯¸ì§€ í’ˆì§ˆ í–¥ìƒ ë° ë…¸ì´ì¦ˆ ì œê±°</p>
                </div>
                <div class="progress-mark">
                    <progress class="progress-bar"  id="progress-bar1" value="0" max="100"></progress>
                    <svg class="progress-checkmark" id="progress-check1"    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                        <!--!Font Awesome Free v7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
                        <path fill="none" d="M530.8 134.1C545.1 144.5 548.3 164.5 537.9 178.8
                           L281.9 530.8C276.4 538.4 267.9 543.1 258.5 543.9
                           C249.1 544.7 240 541.2 233.4 534.6L105.4 406.6
                           C92.9 394.1 92.9 373.8 105.4 361.3
                           C117.9 348.8 138.2 348.8 150.7 361.3
                           L252.2 462.8L486.2 141.1C496.6 126.8 516.6 123.6 530.9 134z"/>
                    </svg>
                </div>
            </div>
            <div class="analyze-process">
                <div class="analyze-info">
                    <h2>ê°ì²´ ê²€ì¶œ</h2>
                    <p>ë¨¸ì‹ ëŸ¬ë‹ ë° ë”¥ëŸ¬ë‹ ëª¨ë¸ì„ í†µí•œ ë¶ˆìˆœë¬¼ ê²€ì¶œ</p>
                </div>
                <div class="progress-mark">
                    <progress class="progress-bar"  id="progress-bar2" value="0" max="100"></progress>
                    <svg class="progress-checkmark" id="progress-check2"    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                        <!--!Font Awesome Free v7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
                        <path fill="none" d="M530.8 134.1C545.1 144.5 548.3 164.5 537.9 178.8
                           L281.9 530.8C276.4 538.4 267.9 543.1 258.5 543.9
                           C249.1 544.7 240 541.2 233.4 534.6L105.4 406.6
                           C92.9 394.1 92.9 373.8 105.4 361.3
                           C117.9 348.8 138.2 348.8 150.7 361.3
                           L252.2 462.8L486.2 141.1C496.6 126.8 516.6 123.6 530.9 134z"/>
                    </svg>
                </div>
            </div>
            <div class="analyze-process">
                <div class="analyze-info">
                    <h2>ë¶ˆìˆœë¬¼ ë¶„ë¥˜</h2>
                    <p>ê²€ì¶œëœ ê°ì²´ì˜ ì¢…ë¥˜ ë° ë¶„ë¥˜</p>
                </div>
                <div class="progress-mark">
                    <progress class="progress-bar"  id="progress-bar3" value="0" max="100"></progress>
                    <svg class="progress-checkmark" id="progress-check3"    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                        <!--!Font Awesome Free v7.0.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
                        <path fill="none" d="M530.8 134.1C545.1 144.5 548.3 164.5 537.9 178.8
                           L281.9 530.8C276.4 538.4 267.9 543.1 258.5 543.9
                           C249.1 544.7 240 541.2 233.4 534.6L105.4 406.6
                           C92.9 394.1 92.9 373.8 105.4 361.3
                           C117.9 348.8 138.2 348.8 150.7 361.3
                           L252.2 462.8L486.2 141.1C496.6 126.8 516.6 123.6 530.9 134z"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>
    <div class="after-upload-container" id="after-upload-container">
        <div class="analyze-ready-container" id="analyze-ready" style="display: none;">
            <p class="cond-label" id="cond-label"></p>
            <button class="analyze-btn" id="start-analyze-btn" style="display:none;">ë¶„ì„ ì‹œì‘</button>
        </div>
        <div class="analyze-done-container" id="analyze-done" style="display: none;">
            <p class="done-label" id="done-label">ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë¶„ì„ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
            <button class="analyze-btn" id="result-analyze-btn">ë¶„ì„ ê²°ê³¼</button>
        </div>
    </div>
</div>


<script>
    const popup = document.getElementById('popup');
    const popup_btn = document.getElementById('notice_icon');
    const close_btn = document.getElementById('close');
    popup_btn.addEventListener('click', () => popup.style.display = 'block');
    close_btn.addEventListener('click', () => popup.style.display = 'none');

    // --- ìš”ì†Œ ì°¸ì¡° ---
    const fileInput = document.getElementById('file-input');
    const selectFileBtn = document.getElementById('select-file-btn');
    const reselectFileBtn = document.getElementById('reselect-file-btn');
    const beforeUpload = document.getElementById('before-upload-container');
    const previewContainer = document.getElementById('preview-container');
    const previewImg = document.getElementById('preview-img');
    const analyzeReady = document.getElementById('analyze-ready');
    const condLabel = document.getElementById('cond-label');
    const analyzeStartBtn = document.getElementById('start-analyze-btn');
    const analyzeDone = document.getElementById('analyze-done');
    const analyzeResultBtn = document.getElementById('result-analyze-btn');
    const uploadContainer = document.querySelector('.upload-container');
    const analyzeContainer = document.querySelector('.analyze-container');

    const validExtensions = ['jpeg', 'jpg', 'png','webp'];
    const maxSize = 10 * 1024 * 1024;
    const csrfToken = document.querySelector('input[name="_csrf"]').value;
    let lastSelectedFile = null;
    let origImageId = null;

// --- í”„ë¡œê·¸ë ˆìŠ¤ë°” ëª©ë¡ ---
    const progressBars = [
        { bar: document.getElementById('progress-bar1'), check: document.getElementById('progress-check1') },
        { bar: document.getElementById('progress-bar2'), check: document.getElementById('progress-check2') },
        { bar: document.getElementById('progress-bar3'), check: document.getElementById('progress-check3') }
];

// --- íŒŒì¼ ì„ íƒ ---
    selectFileBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleFileSelect);
    reselectFileBtn.addEventListener('click', () => { fileInput.value = ''; fileInput.click(); });

    // íŒŒì¼ ì„ íƒ ì‹œ
    function handleFileSelect() {
        if (fileInput.files.length === 0) return;
        const file = fileInput.files[0];
        lastSelectedFile = file;
        const ext = file.name.split('.').pop().toLowerCase();

        if (!validExtensions.includes(ext)) {
            condLabel.innerText = 'ì§€ì›ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. ë‹¤ë¥¸ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
            condLabel.style.color = 'red';
        } else if (file.size > maxSize) {
            condLabel.innerText = 'íŒŒì¼ ìš©ëŸ‰ì´ 10MBë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
            condLabel.style.color = 'red';
        } else {
            condLabel.innerText = '';
            analyzeStartBtn.style.display = 'block';
        }

        beforeUpload.style.display = 'none';
        previewContainer.style.display = 'flex';
        analyzeReady.style.display = 'flex';

        const reader = new FileReader();
        reader.onload = e => previewImg.src = e.target.result;
        reader.readAsDataURL(file);

        fileInput.value = '';
    }

    // --- ë¶„ì„ ì‹œì‘ ---
    analyzeStartBtn.addEventListener('click', async () => {
        const file = fileInput.files.length > 0 ? fileInput.files[0] : lastSelectedFile;
        if (!file) return;

        try {
            prepareUIForAnalysis();

            // 1ï¸âƒ£ ì´ë¯¸ì§€ ê·œê²© ê²€ì‚¬
            await performStep1Validation(file);

            // 2ï¸âƒ£ ë”¥ëŸ¬ë‹ ë¶„ì„ (ê¸°ì¡´ upload)
            await performStep2Analysis(file);

            // 3ï¸âƒ£ ê²°ê³¼ ì •ë¦¬ (í•˜ë“œì½”ë”©)
            await performStep3Finalize();

            showAnalysisComplete();

        } catch (err) {
            console.error('ë¶„ì„ ì‹¤íŒ¨:', err);
            alert('ë¶„ì„ ì‹¤íŒ¨: ' + err.message);
            resetAnalysisUI();

            condLabel.innerText = 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            condLabel.style.color = 'red';
            analyzeReady.style.display = 'flex';
            analyzeStartBtn.style.display = 'none'; // ë¶„ì„ ì‹œì‘ ë²„íŠ¼ì€ ìˆ¨ê¹€


        }
    });

    /**
     * 1ë‹¨ê³„: ì´ë¯¸ì§€ ê·œê²© ê²€ì‚¬
     * ğŸ¯ ì‘ë‹µ ì˜¬ ë•Œê¹Œì§€ 0% ëŒ€ê¸° â†’ ì‘ë‹µ ì˜¤ë©´ 100%ê¹Œì§€ ì±„ìš°ê¸°
     */
    async function performStep1Validation(file) {
        const { bar, check } = progressBars[0];
        bar.value = 0;

        try {
             //âœ… ì‹¤ì œ fetch (ì£¼ì„ í•´ì œ ì‹œ ì‚¬ìš©)
             const formData = new FormData();
             formData.append('image', file);
             const res = await fetch('/api/images/validate', {
                 method: 'POST',
                 headers: { 'X-CSRF-TOKEN': csrfToken },
                 body: formData
             });
             const data = await res.json();

            // ğŸ§ª ê°€ì§œ ì‘ë‹µ ì‹œë®¬ë ˆì´ì…˜ (ì‘ë‹µ ì˜¬ ë•Œê¹Œì§€ ëŒ€ê¸°)
<!--            await new Promise(res => setTimeout(res, 1500));-->
<!--            const data = { status: 0 };-->

            if (data.status !== '0') throw new Error(data.error || 'ì´ë¯¸ì§€ ê·œê²© ê²€ì‚¬ ì‹¤íŒ¨');

            // ğŸ¯ ì‘ë‹µ ì˜¨ í›„ 0 â†’ 100%ê¹Œì§€ ì±„ìš°ê¸°
            await fillProgressBar(bar, 500); // 0.5ì´ˆ ë™ì•ˆ

            // ì²´í¬ë§ˆí¬ ì• ë‹ˆë©”ì´ì…˜
            check.classList.add('animate');
            await sleep(300);
            check.classList.add('fill');
            await sleep(200);

        } catch (err) {
            throw err;
        }
    }

    /**
     * 2ë‹¨ê³„: ë”¥ëŸ¬ë‹ ë¶„ì„
     * ğŸ¯ ì‘ë‹µ ì˜¬ ë•Œê¹Œì§€ 0% ëŒ€ê¸° â†’ ì‘ë‹µ ì˜¤ë©´ 100%ê¹Œì§€ ì±„ìš°ê¸°
     */
    async function performStep2Analysis(file) {
        const { bar, check } = progressBars[1];
        bar.value = 0;

        try {
            // âœ… ì‹¤ì œ fetch (ì£¼ì„ í•´ì œ ì‹œ ì‚¬ìš©)
             const formData = new FormData();
             formData.append('image', file);
             const res = await fetch('/api/images/upload', {
                 method: 'POST',
                 headers: { 'X-CSRF-TOKEN': csrfToken },
                 body: formData
             });
             const data = await res.json();

<!--            // ğŸ§ª ê°€ì§œ ì‘ë‹µ ì‹œë®¬ë ˆì´ì…˜ (ì‘ë‹µ ì˜¬ ë•Œê¹Œì§€ ëŒ€ê¸°)-->
<!--            await new Promise(res => setTimeout(res, 2000));-->
<!--            const data = { id: 'dummy-result-id' };-->

            if (!data.id) throw new Error('ë”¥ëŸ¬ë‹ ë¶„ì„ ì‹¤íŒ¨ (ID ì—†ìŒ)');
            origImageId = data.id;

            // ğŸ¯ ì‘ë‹µ ì˜¨ í›„ 0 â†’ 100%ê¹Œì§€ ì±„ìš°ê¸°
            await fillProgressBar(bar, 600); // 0.6ì´ˆ ë™ì•ˆ

            check.classList.add('animate');
            await sleep(300);
            check.classList.add('fill');
            await sleep(200);

        } catch (err) {
            throw err;
        }
    }

    /**
     * 3ë‹¨ê³„: ê²°ê³¼ ì •ë¦¬ (í•˜ë“œì½”ë”©)
     */
    async function performStep3Finalize() {
        const { bar, check } = progressBars[2];
        bar.value = 0;

        // ì²˜ìŒë¶€í„° ëê¹Œì§€ ë¶€ë“œëŸ½ê²Œ
        await fillProgressBar(bar, 600); // 0.6ì´ˆ ë™ì•ˆ

        check.classList.add('animate');
        await sleep(300);
        check.classList.add('fill');
        await sleep(200);
    }

    /**
     * ğŸ¯ 0%ì—ì„œ 100%ê¹Œì§€ ë¶€ë“œëŸ½ê²Œ ì±„ìš°ëŠ” í•¨ìˆ˜
     * @param {HTMLProgressElement} bar - í”„ë¡œê·¸ë ˆìŠ¤ë°” ìš”ì†Œ
     * @param {number} duration - ì±„ìš°ëŠ”ë° ê±¸ë¦¬ëŠ” ì‹œê°„ (ë°€ë¦¬ì´ˆ)
     */
    async function fillProgressBar(bar, duration) {
        const steps = 30; // ë¶€ë“œëŸ¬ì›€ ì •ë„
        const increment = 100 / steps;
        const delay = duration / steps;

        for (let i = 0; i < steps; i++) {
            bar.value = Math.min(increment * (i + 1), 100);
            await sleep(delay);
        }
        bar.value = 100;
    }

    // --- ìœ í‹¸ë¦¬í‹° ---
    function sleep(ms) { return new Promise(res => setTimeout(res, ms)); }

    function prepareUIForAnalysis() {
        analyzeReady.style.display = 'none';
        reselectFileBtn.style.display = 'none';
        uploadContainer.classList.add('analyzing');
        analyzeContainer.style.display = 'flex';
        analyzeContainer.style.opacity = '1';
    }

    function resetAnalysisUI() {
        uploadContainer.classList.remove('analyzing');
        analyzeContainer.style.display = 'none';
        analyzeReady.style.display = 'flex';
        reselectFileBtn.style.display = 'block';
        progressBars.forEach(({ bar, check }) => {
            bar.value = 0;
            check.classList.remove('animate', 'fill');
        });
    }

    function showAnalysisComplete() {
        analyzeDone.style.display = 'flex';
    }

    analyzeResultBtn.addEventListener('click', () => {
        if (!origImageId) return alert('ê²°ê³¼ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
        window.location.href = '/result/' + origImageId;
    });


</script>
</body>
</html>
